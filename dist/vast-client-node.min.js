"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function createAd(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return{id:e.id||null,sequence:e.sequence||null,adType:e.adType||null,adServingId:null,categories:[],expires:null,viewableImpression:{},system:null,title:null,description:null,advertiser:null,pricing:null,survey:null,errorURLTemplates:[],impressionURLTemplates:[],creatives:[],extensions:[],adVerifications:[]}}function createAdVerification(){return{resource:null,vendor:null,browserOptional:!1,apiFramework:null,type:null,parameters:null,trackingEvents:{}}}function createCompanionAd(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return{id:e.id||null,adType:"companionAd",width:e.width||0,height:e.height||0,assetWidth:e.assetWidth||null,assetHeight:e.assetHeight||null,expandedWidth:e.expandedWidth||null,expandedHeight:e.expandedHeight||null,apiFramework:e.apiFramework||null,adSlotID:e.adSlotID||null,pxratio:e.pxratio||"1",renderingMode:e.renderingMode||"default",staticResources:[],htmlResources:[],iframeResources:[],adParameters:null,xmlEncoded:null,altText:null,companionClickThroughURLTemplate:null,companionClickTrackingURLTemplates:[],trackingEvents:{}}}function isCompanionAd(e){return"companionAd"===e.adType}function createCreative(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return{id:e.id||null,adId:e.adId||null,sequence:e.sequence||null,apiFramework:e.apiFramework||null,universalAdId:{value:null,idRegistry:"unknown"},creativeExtensions:[]}}function createCreativeCompanion(){var e=createCreative(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{});return{id:e.id,adId:e.adId,sequence:e.sequence,apiFramework:e.apiFramework,type:"companion",required:null,variations:[]}}Object.defineProperty(exports,"__esModule",{value:!0});var supportedMacros=["CONTENTPLAYHEAD","ADPLAYHEAD","MEDIAPLAYHEAD","ADPLAYHEAD","ASSETURI","PODSEQUENCE","UNIVERSALADID","CONTENTURI","CONTENTID","VERIFICATIONVENDORS","EXTENSIONS","DEVICEIP","SERVERSIDE","CLIENTUA","SERVERUA","DEVICEUA","TRANSACTIONID","ADCOUNT","BREAKPOSITION","PLACEMENTTYPE","IFA","IFATYPE","LATLONG","DOMAIN","PAGEURL","APPBUNDLE","VASTVERSIONS","APIFRAMEWORKS","MEDIAMIME","PLAYERCAPABILITIES","CLICKTYPE","PLAYERSTATE","INVENTORYSTATE","CLICKPOS","PLAYERSIZE","LIMITADTRACKING","REGULATIONS","GDPRCONSENT","BLOCKEDADCATEGORIES","ADCATEGORIES","ADTYPE","ADSERVINGID"];function track(e,t,r){resolveURLTemplates(e,t,r).forEach(function(e){"undefined"!=typeof window&&null!==window&&((new Image).src=e)})}function resolveURLTemplates(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=[],a=extractURLsFromTemplates(e);for(var n in!t.ERRORCODE||r.isCustomCode||/^[0-9]{3}$/.test(t.ERRORCODE)||(t.ERRORCODE=900),t.CACHEBUSTING=leftpad(Math.round(1e8*Math.random()).toString()),t.TIMESTAMP=(new Date).toISOString(),t.RANDOM=t.random=t.CACHEBUSTING,t)t[n]=encodeURIComponentRFC3986(t[n]);for(var s in a){var o=a[s];"string"==typeof o&&i.push(replaceUrlMacros(o,t))}return i}function replaceUrlMacros(e,t){var r=(e=replaceMacrosValues(e,t)).match(/[^[\]]+(?=])/g);if(!r)return e;var i=r.filter(function(e){return-1<supportedMacros.indexOf(e)});return 0===i.length?e:replaceMacrosValues(e,i=i.reduce(function(e,t){return e[t]=-1,e},{}))}function replaceMacrosValues(e,t){var r=e;for(var i in t){var a=t[i];r=r.replace(new RegExp("(?:\\[|%%)(".concat(i,")(?:\\]|%%)"),"g"),a)}return r}function extractURLsFromTemplates(e){return Array.isArray(e)?e.map(function(e){return e&&e.hasOwnProperty("url")?e.url:e}):e}function containsTemplateObject(e,t){for(var r=0;r<t.length;r++)if(isTemplateObjectEqual(t[r],e))return!0;return!1}function isTemplateObjectEqual(e,t){if(e&&t){var r=Object.getOwnPropertyNames(e),i=Object.getOwnPropertyNames(t);return r.length===i.length&&(e.id===t.id&&e.url===t.url)}return!1}function encodeURIComponentRFC3986(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%".concat(e.charCodeAt(0).toString(16))})}function leftpad(e){return e.length<8?range(0,8-e.length,!1).map(function(){return"0"}).join("")+e:e}function range(e,t,r){for(var i=[],a=e<t,n=r?a?t+1:t-1:t,s=e;a?s<n:n<s;a?s++:s--)i.push(s);return i}function isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}function flatten(e){return e.reduce(function(e,t){return e.concat(Array.isArray(t)?flatten(t):t)},[])}function joinArrayOfUniqueTemplateObjs(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=Array.isArray(e)?e:[],i=Array.isArray(t)?t:[];return r.concat(i).reduce(function(e,t){return containsTemplateObject(t,e)||e.push(t),e},[])}var util={track:track,resolveURLTemplates:resolveURLTemplates,extractURLsFromTemplates:extractURLsFromTemplates,containsTemplateObject:containsTemplateObject,isTemplateObjectEqual:isTemplateObjectEqual,encodeURIComponentRFC3986:encodeURIComponentRFC3986,replaceUrlMacros:replaceUrlMacros,leftpad:leftpad,range:range,isNumeric:isNumeric,flatten:flatten,joinArrayOfUniqueTemplateObjs:joinArrayOfUniqueTemplateObjs};function childByName(e,t){var r=e.childNodes;for(var i in r){var a=r[i];if(a.nodeName===t)return a}}function childrenByName(e,t){var r=[],i=e.childNodes;for(var a in i){var n=i[a];n.nodeName===t&&r.push(n)}return r}function resolveVastAdTagURI(e,t){if(!t)return e;if(0===e.indexOf("//")){var r=location.protocol;return"".concat(r).concat(e)}if(-1!==e.indexOf("://"))return e;var i=t.slice(0,t.lastIndexOf("/"));return"".concat(i,"/").concat(e)}function parseBoolean(e){return-1!==["true","TRUE","True","1"].indexOf(e)}function parseNodeText(e){return e&&(e.textContent||e.text||"").trim()}function copyNodeAttribute(e,t,r){var i=t.getAttribute(e);i&&r.setAttribute(e,i)}function parseAttributes(e){for(var t=e.attributes,r={},i=0;i<t.length;i++)r[t[i].nodeName]=t[i].nodeValue;return r}function parseDuration(e){if(null==e)return-1;if(util.isNumeric(e))return parseInt(e);var t=e.split(":");if(3!==t.length)return-1;var r=t[2].split("."),i=parseInt(r[0]);2===r.length&&(i+=parseFloat("0.".concat(r[1])));var a=parseInt(60*t[1]),n=parseInt(60*t[0]*60);return isNaN(n)||isNaN(a)||isNaN(i)||3600<a||60<i?-1:n+a+i}function splitVAST(i){var a=[],n=null;return i.forEach(function(e,t){if(e.sequence&&(e.sequence=parseInt(e.sequence,10)),1<e.sequence){var r=i[t-1];if(r&&r.sequence===e.sequence-1)return void(n&&n.push(e));delete e.sequence}n=[e],a.push(n)}),a}function assignAttributes(e,t){if(e)for(var r in e){var i=e[r];if(i.nodeName&&i.nodeValue&&t.hasOwnProperty(i.nodeName)){var a=i.nodeValue;"boolean"==typeof t[i.nodeName]&&(a=parseBoolean(a)),t[i.nodeName]=a}}}function mergeWrapperAdData(e,i){e.errorURLTemplates=i.errorURLTemplates.concat(e.errorURLTemplates),e.impressionURLTemplates=i.impressionURLTemplates.concat(e.impressionURLTemplates),e.extensions=i.extensions.concat(e.extensions);var t=(i.creatives||[]).filter(function(e){return e&&"companion"===e.type}),a=t.reduce(function(t,e){return(e.variations||[]).forEach(function(e){(e.companionClickTrackingURLTemplates||[]).forEach(function(e){util.containsTemplateObject(e,t)||t.push(e)})}),t},[]);e.creatives=t.concat(e.creatives);var n=i.videoClickTrackingURLTemplates&&i.videoClickTrackingURLTemplates.length,s=i.videoCustomClickURLTemplates&&i.videoCustomClickURLTemplates.length;e.creatives.forEach(function(e){if(i.trackingEvents&&i.trackingEvents[e.type])for(var t in i.trackingEvents[e.type]){var r=i.trackingEvents[e.type][t];Array.isArray(e.trackingEvents[t])||(e.trackingEvents[t]=[]),e.trackingEvents[t]=e.trackingEvents[t].concat(r)}"linear"===e.type&&(n&&(e.videoClickTrackingURLTemplates=e.videoClickTrackingURLTemplates.concat(i.videoClickTrackingURLTemplates)),s&&(e.videoCustomClickURLTemplates=e.videoCustomClickURLTemplates.concat(i.videoCustomClickURLTemplates)),!i.videoClickThroughURLTemplate||null!==e.videoClickThroughURLTemplate&&void 0!==e.videoClickThroughURLTemplate||(e.videoClickThroughURLTemplate=i.videoClickThroughURLTemplate)),"companion"===e.type&&a.length&&(e.variations||[]).forEach(function(e){e.companionClickTrackingURLTemplates=util.joinArrayOfUniqueTemplateObjs(e.companionClickTrackingURLTemplates,a)})}),i.adVerifications&&(e.adVerifications=e.adVerifications.concat(i.adVerifications))}var parserUtils={childByName:childByName,childrenByName:childrenByName,resolveVastAdTagURI:resolveVastAdTagURI,parseBoolean:parseBoolean,parseNodeText:parseNodeText,copyNodeAttribute:copyNodeAttribute,parseAttributes:parseAttributes,parseDuration:parseDuration,splitVAST:splitVAST,assignAttributes:assignAttributes,mergeWrapperAdData:mergeWrapperAdData};function parseCreativeCompanion(e,t){var r=createCreativeCompanion(t);return r.required=e.getAttribute("required")||null,r.variations=parserUtils.childrenByName(e,"Companion").map(function(e){var i=createCompanionAd(parserUtils.parseAttributes(e));i.htmlResources=parserUtils.childrenByName(e,"HTMLResource").reduce(function(e,t){var r=parserUtils.parseNodeText(t);return r?e.concat(r):e},[]),i.iframeResources=parserUtils.childrenByName(e,"IFrameResource").reduce(function(e,t){var r=parserUtils.parseNodeText(t);return r?e.concat(r):e},[]),i.staticResources=parserUtils.childrenByName(e,"StaticResource").reduce(function(e,t){var r=parserUtils.parseNodeText(t);return r?e.concat({url:r,creativeType:t.getAttribute("creativeType")||null}):e},[]),i.altText=parserUtils.parseNodeText(parserUtils.childByName(e,"AltText"))||null;var t=parserUtils.childByName(e,"TrackingEvents");t&&parserUtils.childrenByName(t,"Tracking").forEach(function(e){var t=e.getAttribute("event"),r=parserUtils.parseNodeText(e);t&&r&&(Array.isArray(i.trackingEvents[t])||(i.trackingEvents[t]=[]),i.trackingEvents[t].push(r))}),i.companionClickTrackingURLTemplates=parserUtils.childrenByName(e,"CompanionClickTracking").map(function(e){return{id:e.getAttribute("id")||null,url:parserUtils.parseNodeText(e)}}),i.companionClickThroughURLTemplate=parserUtils.parseNodeText(parserUtils.childByName(e,"CompanionClickThrough"))||null;var r=parserUtils.childByName(e,"AdParameters");return r&&(i.adParameters=parserUtils.parseNodeText(r),i.xmlEncoded=r.getAttribute("xmlEncoded")||null),i}),r}function createCreativeLinear(){var e=createCreative(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{});return{id:e.id,adId:e.adId,sequence:e.sequence,apiFramework:e.apiFramework,type:"linear",duration:0,skipDelay:null,mediaFiles:[],mezzanine:null,interactiveCreativeFile:null,closedCaptionFiles:[],videoClickThroughURLTemplate:null,videoClickTrackingURLTemplates:[],videoCustomClickURLTemplates:[],adParameters:null,icons:[],trackingEvents:{}}}function isCreativeLinear(e){return"linear"===e.type}function createClosedCaptionFile(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return{type:e.type||null,language:e.language||null,fileURL:null}}function createIcon(){return{program:null,height:0,width:0,xPosition:0,yPosition:0,apiFramework:null,offset:null,duration:0,type:null,staticResource:null,htmlResource:null,iframeResource:null,pxratio:"1",iconClickThroughURLTemplate:null,iconClickTrackingURLTemplates:[],iconViewTrackingURLTemplate:null}}function createInteractiveCreativeFile(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return{type:e.type||null,apiFramework:e.apiFramework||null,variableDuration:parserUtils.parseBoolean(e.variableDuration),fileURL:null}}function createMediaFile(){return{id:null,fileURL:null,fileSize:0,deliveryType:"progressive",mimeType:null,mediaType:null,codec:null,bitrate:0,minBitrate:0,maxBitrate:0,width:0,height:0,apiFramework:null,scalable:null,maintainAspectRatio:null}}function createMezzanine(){return{id:null,fileURL:null,delivery:null,codec:null,type:null,width:0,height:0,fileSize:0,mediaType:"2D"}}function parseCreativeLinear(e,t){var i,s=createCreativeLinear(t);s.duration=parserUtils.parseDuration(parserUtils.parseNodeText(parserUtils.childByName(e,"Duration")));var r=e.getAttribute("skipoffset");if(null==r)s.skipDelay=null;else if("%"===r.charAt(r.length-1)&&-1!==s.duration){var a=parseInt(r,10);s.skipDelay=s.duration*(a/100)}else s.skipDelay=parserUtils.parseDuration(r);var n=parserUtils.childByName(e,"VideoClicks");if(n){var o=parserUtils.childByName(n,"ClickThrough");s.videoClickThroughURLTemplate=o?{id:o.getAttribute("id")||null,url:parserUtils.parseNodeText(o)}:null,parserUtils.childrenByName(n,"ClickTracking").forEach(function(e){s.videoClickTrackingURLTemplates.push({id:e.getAttribute("id")||null,url:parserUtils.parseNodeText(e)})}),parserUtils.childrenByName(n,"CustomClick").forEach(function(e){s.videoCustomClickURLTemplates.push({id:e.getAttribute("id")||null,url:parserUtils.parseNodeText(e)})})}var l=parserUtils.childByName(e,"AdParameters");l&&(s.adParameters=parserUtils.parseNodeText(l)),parserUtils.childrenByName(e,"TrackingEvents").forEach(function(e){parserUtils.childrenByName(e,"Tracking").forEach(function(e){var t=e.getAttribute("event"),r=parserUtils.parseNodeText(e);if(t&&r){if("progress"===t){if(!(i=e.getAttribute("offset")))return;t="%"===i.charAt(i.length-1)?"progress-".concat(i):"progress-".concat(Math.round(parserUtils.parseDuration(i)))}Array.isArray(s.trackingEvents[t])||(s.trackingEvents[t]=[]),s.trackingEvents[t].push(r)}})}),parserUtils.childrenByName(e,"MediaFiles").forEach(function(e){parserUtils.childrenByName(e,"MediaFile").forEach(function(e){s.mediaFiles.push(parseMediaFile(e))});var t=parserUtils.childByName(e,"InteractiveCreativeFile");t&&(s.interactiveCreativeFile=parseInteractiveCreativeFile(t));var r=parserUtils.childByName(e,"ClosedCaptionFiles");r&&parserUtils.childrenByName(r,"ClosedCaptionFile").forEach(function(e){var t=createClosedCaptionFile(parserUtils.parseAttributes(e));t.fileURL=parserUtils.parseNodeText(e),s.closedCaptionFiles.push(t)});var i=parserUtils.childByName(e,"Mezzanine"),a=getRequiredAttributes(i,["delivery","type","width","height"]);if(a){var n=createMezzanine();n.id=i.getAttribute("id"),n.fileURL=parserUtils.parseNodeText(i),n.delivery=a.delivery,n.codec=i.getAttribute("codec"),n.type=a.type,n.width=parseInt(a.width,10),n.height=parseInt(a.height,10),n.fileSize=parseInt(i.getAttribute("fileSize"),10),n.mediaType=i.getAttribute("mediaType")||"2D",s.mezzanine=n}});var u=parserUtils.childByName(e,"Icons");return u&&parserUtils.childrenByName(u,"Icon").forEach(function(e){s.icons.push(parseIcon(e))}),s}function parseMediaFile(e){var t=createMediaFile();t.id=e.getAttribute("id"),t.fileURL=parserUtils.parseNodeText(e),t.deliveryType=e.getAttribute("delivery"),t.codec=e.getAttribute("codec"),t.mimeType=e.getAttribute("type"),t.mediaType=e.getAttribute("mediaType")||"2D",t.apiFramework=e.getAttribute("apiFramework"),t.fileSize=parseInt(e.getAttribute("fileSize")||0),t.bitrate=parseInt(e.getAttribute("bitrate")||0),t.minBitrate=parseInt(e.getAttribute("minBitrate")||0),t.maxBitrate=parseInt(e.getAttribute("maxBitrate")||0),t.width=parseInt(e.getAttribute("width")||0),t.height=parseInt(e.getAttribute("height")||0);var r=e.getAttribute("scalable");r&&"string"==typeof r&&(t.scalable=parserUtils.parseBoolean(r));var i=e.getAttribute("maintainAspectRatio");return i&&"string"==typeof i&&(t.maintainAspectRatio=parserUtils.parseBoolean(i)),t}function parseInteractiveCreativeFile(e){var t=createInteractiveCreativeFile(parserUtils.parseAttributes(e));return t.fileURL=parserUtils.parseNodeText(e),t}function parseIcon(e){var t=createIcon(e);t.program=e.getAttribute("program"),t.height=parseInt(e.getAttribute("height")||0),t.width=parseInt(e.getAttribute("width")||0),t.xPosition=parseXPosition(e.getAttribute("xPosition")),t.yPosition=parseYPosition(e.getAttribute("yPosition")),t.apiFramework=e.getAttribute("apiFramework"),t.pxratio=e.getAttribute("pxratio")||"1",t.offset=parserUtils.parseDuration(e.getAttribute("offset")),t.duration=parserUtils.parseDuration(e.getAttribute("duration")),parserUtils.childrenByName(e,"HTMLResource").forEach(function(e){t.type=e.getAttribute("creativeType")||"text/html",t.htmlResource=parserUtils.parseNodeText(e)}),parserUtils.childrenByName(e,"IFrameResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.iframeResource=parserUtils.parseNodeText(e)}),parserUtils.childrenByName(e,"StaticResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.staticResource=parserUtils.parseNodeText(e)});var r=parserUtils.childByName(e,"IconClicks");return r&&(t.iconClickThroughURLTemplate=parserUtils.parseNodeText(parserUtils.childByName(r,"IconClickThrough")),parserUtils.childrenByName(r,"IconClickTracking").forEach(function(e){t.iconClickTrackingURLTemplates.push({id:e.getAttribute("id")||null,url:parserUtils.parseNodeText(e)})})),t.iconViewTrackingURLTemplate=parserUtils.parseNodeText(parserUtils.childByName(e,"IconViewTracking")),t}function parseXPosition(e){return-1!==["left","right"].indexOf(e)?e:parseInt(e||0)}function parseYPosition(e){return-1!==["top","bottom"].indexOf(e)?e:parseInt(e||0)}function getRequiredAttributes(t,e){var r={},i=!1;return e.forEach(function(e){t&&t.getAttribute(e)?r[e]=t.getAttribute(e):i=!0}),i?null:r}function createCreativeNonLinear(){var e=createCreative(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{});return{id:e.id,adId:e.adId,sequence:e.sequence,apiFramework:e.apiFramework,type:"nonlinear",variations:[],trackingEvents:{}}}function createNonLinearAd(){return{id:null,width:0,height:0,expandedWidth:0,expandedHeight:0,scalable:!0,maintainAspectRatio:!0,minSuggestedDuration:0,apiFramework:"static",adType:"nonLinearAd",type:null,staticResource:null,htmlResource:null,iframeResource:null,nonlinearClickThroughURLTemplate:null,nonlinearClickTrackingURLTemplates:[],adParameters:null}}function isNonLinearAd(e){return"nonLinearAd"===e.adType}function parseCreativeNonLinear(e,t){var i=createCreativeNonLinear(t);return parserUtils.childrenByName(e,"TrackingEvents").forEach(function(e){var t,r;parserUtils.childrenByName(e,"Tracking").forEach(function(e){t=e.getAttribute("event"),r=parserUtils.parseNodeText(e),t&&r&&(Array.isArray(i.trackingEvents[t])||(i.trackingEvents[t]=[]),i.trackingEvents[t].push(r))})}),parserUtils.childrenByName(e,"NonLinear").forEach(function(e){var t=createNonLinearAd();t.id=e.getAttribute("id")||null,t.width=e.getAttribute("width"),t.height=e.getAttribute("height"),t.expandedWidth=e.getAttribute("expandedWidth"),t.expandedHeight=e.getAttribute("expandedHeight"),t.scalable=parserUtils.parseBoolean(e.getAttribute("scalable")),t.maintainAspectRatio=parserUtils.parseBoolean(e.getAttribute("maintainAspectRatio")),t.minSuggestedDuration=parserUtils.parseDuration(e.getAttribute("minSuggestedDuration")),t.apiFramework=e.getAttribute("apiFramework"),parserUtils.childrenByName(e,"HTMLResource").forEach(function(e){t.type=e.getAttribute("creativeType")||"text/html",t.htmlResource=parserUtils.parseNodeText(e)}),parserUtils.childrenByName(e,"IFrameResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.iframeResource=parserUtils.parseNodeText(e)}),parserUtils.childrenByName(e,"StaticResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.staticResource=parserUtils.parseNodeText(e)});var r=parserUtils.childByName(e,"AdParameters");r&&(t.adParameters=parserUtils.parseNodeText(r)),t.nonlinearClickThroughURLTemplate=parserUtils.parseNodeText(parserUtils.childByName(e,"NonLinearClickThrough")),parserUtils.childrenByName(e,"NonLinearClickTracking").forEach(function(e){t.nonlinearClickTrackingURLTemplates.push({id:e.getAttribute("id")||null,url:parserUtils.parseNodeText(e)})}),i.variations.push(t)}),i}function createExtension(){return{name:null,value:null,attributes:{},children:[]}}function isEmptyExtension(e){return null===e.value&&0===Object.keys(e.attributes).length&&0===e.children.length}function parseExtensions(e){var r=[];return e.forEach(function(e){var t=_parseExtension(e);t&&r.push(t)}),r}function _parseExtension(e){if("#comment"===e.nodeName)return null;var t=createExtension(),r=e.attributes,i=e.childNodes;if(t.name=e.nodeName,e.attributes)for(var a in r)if(r.hasOwnProperty(a)){var n=r[a];n.nodeName&&n.nodeValue&&(t.attributes[n.nodeName]=n.nodeValue)}for(var s in i)if(i.hasOwnProperty(s)){var o=_parseExtension(i[s]);o&&t.children.push(o)}if(0===t.children.length||1===t.children.length&&0<=["#cdata-section","#text"].indexOf(t.children[0].name)){var l=parserUtils.parseNodeText(e);""!==l&&(t.value=l),t.children=[]}return isEmptyExtension(t)?null:t}function parseCreatives(e){var u=[];return e.forEach(function(e){var t,r,i={id:e.getAttribute("id")||null,adId:parseCreativeAdIdAttribute(e),sequence:e.getAttribute("sequence")||null,apiFramework:e.getAttribute("apiFramework")||null},a=parserUtils.childByName(e,"UniversalAdId");a&&(t={idRegistry:a.getAttribute("idRegistry")||"unknown",value:parserUtils.parseNodeText(a)});var n=parserUtils.childByName(e,"CreativeExtensions");for(var s in n&&(r=parseExtensions(parserUtils.childrenByName(n,"CreativeExtension"))),e.childNodes){var o=e.childNodes[s],l=void 0;switch(o.nodeName){case"Linear":l=parseCreativeLinear(o,i);break;case"NonLinearAds":l=parseCreativeNonLinear(o,i);break;case"CompanionAds":l=parseCreativeCompanion(o,i)}l&&(t&&(l.universalAdId=t),r&&(l.creativeExtensions=r),u.push(l))}}),u}function parseCreativeAdIdAttribute(e){return e.getAttribute("AdID")||e.getAttribute("adID")||e.getAttribute("adId")||null}var requiredValues={Wrapper:{subElements:["VASTAdTagURI","Impression"]},BlockedAdCategories:{attributes:["authority"]},InLine:{subElements:["AdSystem","AdTitle","Impression","AdServingId","Creatives"]},Category:{attributes:["authority"]},Pricing:{attributes:["model","currency"]},Verification:{oneOfinLineResources:["JavaScriptResource","ExecutableResource"],attributes:["vendor"]},UniversalAdId:{attributes:["idRegistry"]},JavaScriptResource:{attributes:["apiFramework","browserOptional"]},ExecutableResource:{attributes:["apiFramework","type"]},Tracking:{attributes:["event"]},Creatives:{subElements:["Creative"]},Creative:{subElements:["UniversalAdId"]},Linear:{subElements:["MediaFiles","Duration"]},MediaFiles:{subElements:["MediaFile"]},MediaFile:{attributes:["delivery","type","width","height"]},Mezzanine:{attributes:["delivery","type","width","height"]},NonLinear:{oneOfinLineResources:["StaticResource","IFrameResource","HTMLResource"],attributes:["width","height"]},Companion:{oneOfinLineResources:["StaticResource","IFrameResource","HTMLResource"],attributes:["width","height"]},StaticResource:{attributes:["creativeType"]},Icons:{subElements:["Icon"]},Icon:{oneOfinLineResources:["StaticResource","IFrameResource","HTMLResource"]}};function verifyRequiredValues(e,t,r){if(e&&e.nodeName)if("InLine"===e.nodeName&&(r=!0),verifyRequiredAttributes(e,t),hasSubElements(e)){verifyRequiredSubElements(e,t,r);for(var i=0;i<e.children.length;i++)verifyRequiredValues(e.children[i],t,r)}else 0===parserUtils.parseNodeText(e).length&&emitMissingValueWarning({name:e.nodeName,parentName:e.parentNode.nodeName},t)}function verifyRequiredAttributes(t,e){if(requiredValues[t.nodeName]&&requiredValues[t.nodeName].attributes){var r=requiredValues[t.nodeName].attributes.filter(function(e){return!t.getAttribute(e)});0<r.length&&emitMissingValueWarning({name:t.nodeName,parentName:t.parentNode.nodeName,attributes:r},e)}}function verifyRequiredSubElements(t,e,r){var i=requiredValues[t.nodeName],a=!r&&"Wrapper"!==t.nodeName;if(i&&!a){if(i.subElements){var n=i.subElements.filter(function(e){return!parserUtils.childByName(t,e)});0<n.length&&emitMissingValueWarning({name:t.nodeName,parentName:t.parentNode.nodeName,subElements:n},e)}if(r&&i.oneOfinLineResources)i.oneOfinLineResources.some(function(e){return parserUtils.childByName(t,e)})||emitMissingValueWarning({name:t.nodeName,parentName:t.parentNode.nodeName,oneOfResources:i.oneOfinLineResources},e)}}function hasSubElements(e){return e.children&&0!==e.children.length}function emitMissingValueWarning(e,t){var r=e.name,i=e.parentName,a=e.attributes,n=e.subElements,s=e.oneOfResources,o="Element '".concat(r,"'");t("VAST-warning",{message:o+=a?" missing required attribute(s) '".concat(a.join(", "),"' "):n?" missing required sub element(s) '".concat(n.join(", "),"' "):s?" must provide one of the following '".concat(s.join(", "),"' "):" is empty",parentElement:i,specVersion:4.1})}var parserVerification={verifyRequiredValues:verifyRequiredValues,hasSubElements:hasSubElements,emitMissingValueWarning:emitMissingValueWarning,verifyRequiredAttributes:verifyRequiredAttributes,verifyRequiredSubElements:verifyRequiredSubElements};function parseAd(e,t){var r=e.childNodes;for(var i in r){var a=r[i];if(-1!==["Wrapper","InLine"].indexOf(a.nodeName)){if(parserUtils.copyNodeAttribute("id",e,a),parserUtils.copyNodeAttribute("sequence",e,a),parserUtils.copyNodeAttribute("adType",e,a),"Wrapper"===a.nodeName)return{ad:parseWrapper(a,t),type:"WRAPPER"};if("InLine"===a.nodeName)return{ad:parseInLine(a,t),type:"INLINE"}}}}function parseInLine(e,t){return parseAdElement(e,t)}function parseAdElement(e,t){t&&parserVerification.verifyRequiredValues(e,t);var r=e.childNodes,i=createAd(parserUtils.parseAttributes(e));for(var a in r){var n=r[a];switch(n.nodeName){case"Error":i.errorURLTemplates.push(parserUtils.parseNodeText(n));break;case"Impression":i.impressionURLTemplates.push({id:n.getAttribute("id")||null,url:parserUtils.parseNodeText(n)});break;case"Creatives":i.creatives=parseCreatives(parserUtils.childrenByName(n,"Creative"));break;case"Extensions":var s=parserUtils.childrenByName(n,"Extension");i.extensions=parseExtensions(s),i.adVerifications.length||(i.adVerifications=_parseAdVerificationsFromExensions(s));break;case"AdVerifications":i.adVerifications=_parseAdVerifications(parserUtils.childrenByName(n,"Verification"));break;case"AdSystem":i.system={value:parserUtils.parseNodeText(n),version:n.getAttribute("version")||null};break;case"AdTitle":i.title=parserUtils.parseNodeText(n);break;case"AdServingId":i.adServingId=parserUtils.parseNodeText(n);break;case"Category":i.categories.push({authority:n.getAttribute("authority")||null,value:parserUtils.parseNodeText(n)});break;case"Expires":i.expires=parseInt(parserUtils.parseNodeText(n),10);break;case"ViewableImpression":i.viewableImpression=_parseViewableImpression(n);break;case"Description":i.description=parserUtils.parseNodeText(n);break;case"Advertiser":i.advertiser={id:n.getAttribute("id")||null,value:parserUtils.parseNodeText(n)};break;case"Pricing":i.pricing={value:parserUtils.parseNodeText(n),model:n.getAttribute("model")||null,currency:n.getAttribute("currency")||null};break;case"Survey":i.survey=parserUtils.parseNodeText(n)}}return i}function parseWrapper(e,t){var i=parseAdElement(e,t),r=parserUtils.childByName(e,"VASTAdTagURI");if(r?i.nextWrapperURL=parserUtils.parseNodeText(r):(r=parserUtils.childByName(e,"VASTAdTagURL"))&&(i.nextWrapperURL=parserUtils.parseNodeText(parserUtils.childByName(r,"URL"))),i.creatives.forEach(function(r){if(-1!==["linear","nonlinear"].indexOf(r.type)){if(r.trackingEvents){i.trackingEvents||(i.trackingEvents={}),i.trackingEvents[r.type]||(i.trackingEvents[r.type]={});var e=function(t){var e=r.trackingEvents[t];Array.isArray(i.trackingEvents[r.type][t])||(i.trackingEvents[r.type][t]=[]),e.forEach(function(e){i.trackingEvents[r.type][t].push(e)})};for(var t in r.trackingEvents)e(t)}r.videoClickTrackingURLTemplates&&(Array.isArray(i.videoClickTrackingURLTemplates)||(i.videoClickTrackingURLTemplates=[]),r.videoClickTrackingURLTemplates.forEach(function(e){i.videoClickTrackingURLTemplates.push(e)})),r.videoClickThroughURLTemplate&&(i.videoClickThroughURLTemplate=r.videoClickThroughURLTemplate),r.videoCustomClickURLTemplates&&(Array.isArray(i.videoCustomClickURLTemplates)||(i.videoCustomClickURLTemplates=[]),r.videoCustomClickURLTemplates.forEach(function(e){i.videoCustomClickURLTemplates.push(e)}))}}),i.nextWrapperURL)return i}function _parseAdVerifications(e){var s=[];return e.forEach(function(e){var i=createAdVerification(),t=e.childNodes;for(var r in parserUtils.assignAttributes(e.attributes,i),t){var a=t[r];switch(a.nodeName){case"JavaScriptResource":case"ExecutableResource":i.resource=parserUtils.parseNodeText(a),parserUtils.assignAttributes(a.attributes,i);break;case"VerificationParameters":i.parameters=parserUtils.parseNodeText(a)}}var n=parserUtils.childByName(e,"TrackingEvents");n&&parserUtils.childrenByName(n,"Tracking").forEach(function(e){var t=e.getAttribute("event"),r=parserUtils.parseNodeText(e);t&&r&&(Array.isArray(i.trackingEvents[t])||(i.trackingEvents[t]=[]),i.trackingEvents[t].push(r))}),s.push(i)}),s}function _parseAdVerificationsFromExensions(e){var t=null,r=[];return e.some(function(e){return t=parserUtils.childByName(e,"AdVerifications")}),t&&(r=_parseAdVerifications(parserUtils.childrenByName(t,"Verification"))),r}function _parseViewableImpression(e){var t={};t.id=e.getAttribute("id")||null;var r=e.childNodes;for(var i in r){var a=r[i],n=a.nodeName,s=parserUtils.parseNodeText(a);if(("Viewable"===n||"NotViewable"===n||"ViewUndetermined"===n)&&s){var o=n.toLowerCase();Array.isArray(t[o])||(t[o]=[]),t[o].push(s)}}return t}var EventEmitter=function(){function e(){_classCallCheck(this,e),this._handlers=[]}return _createClass(e,[{key:"on",value:function(e,t){if("function"!=typeof t)throw new TypeError("The handler argument must be of type Function. Received type ".concat(_typeof(t)));if(!e)throw new TypeError("The event argument must be of type String. Received type ".concat(_typeof(e)));return this._handlers.push({event:e,handler:t}),this}},{key:"once",value:function(e,t){return this.on(e,onceWrap(this,e,t))}},{key:"off",value:function(t,r){return this._handlers=this._handlers.filter(function(e){return e.event!==t||e.handler!==r}),this}},{key:"emit",value:function(t){for(var e=arguments.length,r=new Array(1<e?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];var a=!1;return this._handlers.forEach(function(e){"*"===e.event&&(a=!0,e.handler.apply(e,[t].concat(r))),e.event===t&&(a=!0,e.handler.apply(e,r))}),a}},{key:"removeAllListeners",value:function(t){return this._handlers=t?this._handlers.filter(function(e){return e.event!==t}):[],this}},{key:"listenerCount",value:function(t){return this._handlers.filter(function(e){return e.event===t}).length}},{key:"listeners",value:function(r){return this._handlers.reduce(function(e,t){return t.event===r&&e.push(t.handler),e},[])}},{key:"eventNames",value:function(){return this._handlers.map(function(e){return e.event})}}]),e}();function onceWrap(e,t,r){var i={fired:!1,wrapFn:void 0};function a(){i.fired||(e.off(t,i.wrapFn),i.fired=!0,r.bind(e).apply(void 0,arguments))}return i.wrapFn=a}var DEFAULT_TIMEOUT=12e4,uri=require("url"),fs=require("fs"),http=require("http"),https=require("https"),DOMParser=require("xmldom").DOMParser;function get(e,t,i){var r="https:"===(e=uri.parse(e)).protocol?https:http;if("file:"===e.protocol)fs.readFile(uri.fileURLToPath(e.href),"utf8",function(e,t){if(e)return i(e);var r=(new DOMParser).parseFromString(t);i(null,r,{byteLength:Buffer.from(t).byteLength})});else{var a,n="",s=t.timeout||DEFAULT_TIMEOUT,o=r.get(e.href,function(t){t.on("data",function(e){n+=e,clearTimeout(a),a=l()}),t.on("end",function(){clearTimeout(a);var e=(new DOMParser).parseFromString(n);i(null,e,{byteLength:Buffer.from(n).byteLength,statusCode:t.statusCode})})});o.on("error",function(e){clearTimeout(a),o.aborted?i(new Error("NodeURLHandler: Request timed out after ".concat(s," ms.")),null,{statusCode:408}):i(e)});var l=function(){return setTimeout(function(){return o.abort()},s)};a=l()}}var nodeURLHandler={get:get};function xhr(){try{var e=new window.XMLHttpRequest;return"withCredentials"in e?e:null}catch(e){return null}}function supported(){return!!xhr()}function handleLoad(e,t){200===e.status?t(null,e.responseXML,{byteLength:e.response.length,statusCode:e.status}):handleFail(e,t,!1)}function handleFail(e,t,r){var i=r?408:e.status,a=r?"XHRURLHandler: Request timed out after ".concat(e.timeout," ms (").concat(i,")"):"XHRURLHandler: ".concat(e.statusText," (").concat(i,")");t(new Error(a),null,{statusCode:i})}function get$1(e,t,r){if("https:"===window.location.protocol&&0===e.indexOf("http://"))return r(new Error("XHRURLHandler: Cannot go from HTTPS to HTTP."));try{var i=xhr();i.open("GET",e),i.timeout=t.timeout||DEFAULT_TIMEOUT,i.withCredentials=t.withCredentials||!1,i.overrideMimeType&&i.overrideMimeType("text/xml"),i.onload=function(){return handleLoad(i,r)},i.onerror=function(){return handleFail(i,r,!1)},i.onabort=function(){return handleFail(i,r,!1)},i.ontimeout=function(){return handleFail(i,r,!0)},i.send()}catch(e){r(new Error("XHRURLHandler: Unexpected error"))}}var XHRURLHandler={get:get$1,supported:supported};function get$2(e,t,r){return r||("function"==typeof t&&(r=t),t={}),"undefined"==typeof window||null===window?nodeURLHandler.get(e,t,r):XHRURLHandler.supported()?XHRURLHandler.get(e,t,r):r(new Error("Current context is not supported by any of the default URLHandlers. Please provide a custom URLHandler"))}var urlHandler={get:get$2};function createVASTResponse(e){return{ads:e.ads||[],errorURLTemplates:e.errorURLTemplates||[],version:e.version||null}}var DEFAULT_MAX_WRAPPER_DEPTH=10,DEFAULT_EVENT_DATA={ERRORCODE:900,extensions:[]},VASTParser=function(e){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this))).remainingAds=[],e.parentURLs=[],e.errorURLTemplates=[],e.rootErrorURLTemplates=[],e.maxWrapperDepth=null,e.URLTemplateFilters=[],e.fetchingOptions={},e}return _inherits(t,EventEmitter),_createClass(t,[{key:"addURLTemplateFilter",value:function(e){"function"==typeof e&&this.URLTemplateFilters.push(e)}},{key:"removeURLTemplateFilter",value:function(){this.URLTemplateFilters.pop()}},{key:"countURLTemplateFilters",value:function(){return this.URLTemplateFilters.length}},{key:"clearURLTemplateFilters",value:function(){this.URLTemplateFilters=[]}},{key:"trackVastError",value:function(e,t){for(var r=arguments.length,i=new Array(2<r?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];this.emit("VAST-error",Object.assign.apply(Object,[DEFAULT_EVENT_DATA,t].concat(i))),util.track(e,t)}},{key:"getErrorURLTemplates",value:function(){return this.rootErrorURLTemplates.concat(this.errorURLTemplates)}},{key:"fetchVAST",value:function(l){var u=this,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,p=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;return new Promise(function(n,s){u.URLTemplateFilters.forEach(function(e){l=e(l)}),u.parentURLs.push(l);var o=Date.now();u.emit("VAST-resolving",{url:l,previousUrl:p,wrapperDepth:c,maxWrapperDepth:u.maxWrapperDepth,timeout:u.fetchingOptions.timeout}),u.urlHandler.get(l,u.fetchingOptions,function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=Math.round(Date.now()-o),a=Object.assign({url:l,previousUrl:p,wrapperDepth:c,error:e,duration:i},r);u.emit("VAST-resolved",a),e?s(e):n(t)})})}},{key:"initParsingStatus",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.rootURL="",this.remainingAds=[],this.parentURLs=[],this.errorURLTemplates=[],this.rootErrorURLTemplates=[],this.maxWrapperDepth=e.wrapperLimit||DEFAULT_MAX_WRAPPER_DEPTH,this.fetchingOptions={timeout:e.timeout||DEFAULT_TIMEOUT,withCredentials:e.withCredentials},this.urlHandler=e.urlHandler||e.urlhandler||urlHandler,this.vastVersion=null}},{key:"getRemainingAds",value:function(e){var t=this;if(0===this.remainingAds.length)return Promise.reject(new Error("No more ads are available for the given VAST"));var r=e?util.flatten(this.remainingAds):this.remainingAds.shift();return this.errorURLTemplates=[],this.parentURLs=[],this.resolveAds(r,{wrapperDepth:0,url:this.rootURL}).then(function(e){return t.buildVASTResponse(e)})}},{key:"getAndParseVAST",value:function(t){var r=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(i),this.URLTemplateFilters.forEach(function(e){t=e(t)}),this.rootURL=t,this.fetchVAST(t).then(function(e){return i.previousUrl=t,i.isRootVAST=!0,i.url=t,r.parse(e,i).then(function(e){return r.buildVASTResponse(e)})})}},{key:"parseVAST",value:function(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(r),r.isRootVAST=!0,this.parse(e,r).then(function(e){return t.buildVASTResponse(e)})}},{key:"buildVASTResponse",value:function(e){var t=createVASTResponse({ads:e,errorURLTemplates:this.getErrorURLTemplates(),version:this.vastVersion});return this.completeWrapperResolving(t),t}},{key:"parseVastXml",value:function(e,t){var r=t.isRootVAST,i=void 0!==r&&r,a=t.url,n=void 0===a?null:a,s=t.wrapperDepth,o=void 0===s?0:s;if(!e||!e.documentElement||"VAST"!==e.documentElement.nodeName)throw this.emit("VAST-ad-parsed",{type:"ERROR",url:n,wrapperDepth:o}),new Error("Invalid VAST XMLDocument");var l=[],u=e.documentElement.childNodes,c=e.documentElement.getAttribute("version");for(var p in i&&c&&(this.vastVersion=c),u){var d=u[p];if("Error"===d.nodeName){var h=parserUtils.parseNodeText(d);i?this.rootErrorURLTemplates.push(h):this.errorURLTemplates.push(h)}else if("Ad"===d.nodeName){var v=parseAd(d,this.emit.bind(this));v.ad?(l.push(v.ad),this.emit("VAST-ad-parsed",{type:v.type,url:n,wrapperDepth:o,adIndex:l.length-1,vastVersion:c})):this.trackVastError(this.getErrorURLTemplates(),{ERRORCODE:101})}}return l}},{key:"parse",value:function(e,t){var r=t.url,i=void 0===r?null:r,a=t.resolveAll,n=void 0===a||a,s=t.wrapperSequence,o=void 0===s?null:s,l=t.previousUrl,u=void 0===l?null:l,c=t.wrapperDepth,p=void 0===c?0:c,d=t.isRootVAST,h=void 0!==d&&d,v=[];try{v=this.parseVastXml(e,{isRootVAST:h,url:i,wrapperDepth:p})}catch(e){return Promise.reject(e)}var m=v.length,f=v[m-1];return 1===m&&null!=o&&f&&!f.sequence&&(f.sequence=o),!1===n&&(this.remainingAds=parserUtils.splitVAST(v),v=this.remainingAds.shift()),this.resolveAds(v,{wrapperDepth:p,previousUrl:u,url:i})}},{key:"resolveAds",value:function(){var i=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length?arguments[1]:void 0,a=t.wrapperDepth,n=t.previousUrl,s=t.url,r=[];return n=s,e.forEach(function(e){var t=i.resolveWrappers(e,a,n);r.push(t)}),Promise.all(r).then(function(e){var t=util.flatten(e);if(!t&&0<i.remainingAds.length){var r=i.remainingAds.shift();return i.resolveAds(r,{wrapperDepth:a,previousUrl:n,url:s})}return t})}},{key:"resolveWrappers",value:function(i,a,n){var s=this;return new Promise(function(t){if(a++,!i.nextWrapperURL)return delete i.nextWrapperURL,t(i);if(a>=s.maxWrapperDepth||-1!==s.parentURLs.indexOf(i.nextWrapperURL))return i.errorCode=302,delete i.nextWrapperURL,t(i);i.nextWrapperURL=parserUtils.resolveVastAdTagURI(i.nextWrapperURL,n),s.URLTemplateFilters.forEach(function(e){i.nextWrapperURL=e(i.nextWrapperURL)});var r=i.sequence;s.fetchVAST(i.nextWrapperURL,a,n).then(function(e){return s.parse(e,{url:i.nextWrapperURL,previousUrl:n,wrapperSequence:r,wrapperDepth:a}).then(function(e){if(delete i.nextWrapperURL,0===e.length)return i.creatives=[],t(i);e.forEach(function(e){e&&parserUtils.mergeWrapperAdData(e,i)}),t(e)})}).catch(function(e){i.errorCode=301,i.errorMessage=e.message,t(i)})})}},{key:"completeWrapperResolving",value:function(e){if(0===e.ads.length)this.trackVastError(e.errorURLTemplates,{ERRORCODE:303});else for(var t=e.ads.length-1;0<=t;t--){var r=e.ads[t];(r.errorCode||0===r.creatives.length)&&(this.trackVastError(r.errorURLTemplates.concat(e.errorURLTemplates),{ERRORCODE:r.errorCode||303},{ERRORMESSAGE:r.errorMessage||""},{extensions:r.extensions},{system:r.system}),e.ads.splice(t,1))}}}]),t}(),storage=null,DEFAULT_STORAGE={data:{},length:0,getItem:function(e){return this.data[e]},setItem:function(e,t){this.data[e]=t,this.length=Object.keys(this.data).length},removeItem:function(e){delete this.data[e],this.length=Object.keys(this.data).length},clear:function(){this.data={},this.length=0}},Storage=function(){function e(){_classCallCheck(this,e),this.storage=this.initStorage()}return _createClass(e,[{key:"initStorage",value:function(){if(storage)return storage;try{storage="undefined"!=typeof window&&null!==window?window.localStorage||window.sessionStorage:null}catch(e){storage=null}return storage&&!this.isStorageDisabled(storage)||(storage=DEFAULT_STORAGE).clear(),storage}},{key:"isStorageDisabled",value:function(e){var t="__VASTStorage__";try{if(e.setItem(t,t),e.getItem(t)!==t)return e.removeItem(t),!0}catch(e){return!0}return e.removeItem(t),!1}},{key:"getItem",value:function(e){return this.storage.getItem(e)}},{key:"setItem",value:function(e,t){return this.storage.setItem(e,t)}},{key:"removeItem",value:function(e){return this.storage.removeItem(e)}},{key:"clear",value:function(){return this.storage.clear()}}]),e}(),VASTClient=function(){function i(e,t,r){_classCallCheck(this,i),this.cappingFreeLunch=e||0,this.cappingMinimumTimeInterval=t||0,this.defaultOptions={withCredentials:!1,timeout:0},this.vastParser=new VASTParser,this.storage=r||new Storage,void 0===this.lastSuccessfulAd&&(this.lastSuccessfulAd=0),void 0===this.totalCalls&&(this.totalCalls=0),void 0===this.totalCallsTimeout&&(this.totalCallsTimeout=0)}return _createClass(i,[{key:"getParser",value:function(){return this.vastParser}},{key:"hasRemainingAds",value:function(){return 0<this.vastParser.remainingAds.length}},{key:"getNextAds",value:function(e){return this.vastParser.getRemainingAds(e)}},{key:"get",value:function(i){var a=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s=Date.now();return(n=Object.assign(this.defaultOptions,n)).hasOwnProperty("resolveAll")||(n.resolveAll=!1),this.totalCallsTimeout<s?(this.totalCalls=1,this.totalCallsTimeout=s+36e5):this.totalCalls++,new Promise(function(t,r){if(a.cappingFreeLunch>=a.totalCalls)return r(new Error("VAST call canceled – FreeLunch capping not reached yet ".concat(a.totalCalls,"/").concat(a.cappingFreeLunch)));var e=s-a.lastSuccessfulAd;if(e<0)a.lastSuccessfulAd=0;else if(e<a.cappingMinimumTimeInterval)return r(new Error("VAST call canceled – (".concat(a.cappingMinimumTimeInterval,")ms minimum interval reached")));a.vastParser.getAndParseVAST(i,n).then(function(e){return t(e)}).catch(function(e){return r(e)})})}},{key:"lastSuccessfulAd",get:function(){return this.storage.getItem("vast-client-last-successful-ad")},set:function(e){this.storage.setItem("vast-client-last-successful-ad",e)}},{key:"totalCalls",get:function(){return this.storage.getItem("vast-client-total-calls")},set:function(e){this.storage.setItem("vast-client-total-calls",e)}},{key:"totalCallsTimeout",get:function(){return this.storage.getItem("vast-client-total-calls-timeout")},set:function(e){this.storage.setItem("vast-client-total-calls-timeout",e)}}]),i}(),DEFAULT_SKIP_DELAY=-1,VASTTracker=function(e){function o(e,t,r){var i,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;for(var n in _classCallCheck(this,o),(i=_possibleConstructorReturn(this,_getPrototypeOf(o).call(this))).ad=t,i.creative=r,i.variation=a,i.muted=!1,i.impressed=!1,i.skippable=!1,i.trackingEvents={},i._alreadyTriggeredQuartiles={},i.emitAlwaysEvents=["creativeView","start","firstQuartile","midpoint","thirdQuartile","complete","resume","pause","rewind","skip","closeLinear","close"],i.creative.trackingEvents){var s=i.creative.trackingEvents[n];i.trackingEvents[n]=s.slice(0)}return isCreativeLinear(i.creative)?i._initLinearTracking():i._initVariationTracking(),e&&i.on("start",function(){e.lastSuccessfulAd=Date.now()}),i}return _inherits(o,EventEmitter),_createClass(o,[{key:"_initLinearTracking",value:function(){this.linear=!0,this.skipDelay=this.creative.skipDelay,this.setDuration(this.creative.duration),this.clickThroughURLTemplate=this.creative.videoClickThroughURLTemplate,this.clickTrackingURLTemplates=this.creative.videoClickTrackingURLTemplates}},{key:"_initVariationTracking",value:function(){if(this.linear=!1,this.skipDelay=DEFAULT_SKIP_DELAY,this.variation){for(var e in this.variation.trackingEvents){var t=this.variation.trackingEvents[e];this.trackingEvents[e]?this.trackingEvents[e]=this.trackingEvents[e].concat(t.slice(0)):this.trackingEvents[e]=t.slice(0)}isNonLinearAd(this.variation)?(this.clickThroughURLTemplate=this.variation.nonlinearClickThroughURLTemplate,this.clickTrackingURLTemplates=this.variation.nonlinearClickTrackingURLTemplates,this.setDuration(this.variation.minSuggestedDuration)):isCompanionAd(this.variation)&&(this.clickThroughURLTemplate=this.variation.companionClickThroughURLTemplate,this.clickTrackingURLTemplates=this.variation.companionClickTrackingURLTemplates)}}},{key:"setDuration",value:function(e){this.assetDuration=e,this.quartiles={firstQuartile:Math.round(25*this.assetDuration)/100,midpoint:Math.round(50*this.assetDuration)/100,thirdQuartile:Math.round(75*this.assetDuration)/100}}},{key:"setProgress",value:function(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=this.skipDelay||DEFAULT_SKIP_DELAY;if(-1===i||this.skippable||(e<i?this.emit("skip-countdown",i-e):(this.skippable=!0,this.emit("skip-countdown",0))),0<this.assetDuration){var a=[];if(0<e){var n=Math.round(e/this.assetDuration*100);for(var s in a.push("start"),a.push("progress-".concat(n,"%")),a.push("progress-".concat(Math.round(e))),this.quartiles)this.isQuartileReached(s,this.quartiles[s],e)&&(a.push(s),this._alreadyTriggeredQuartiles[s]=!0)}a.forEach(function(e){t.track(e,{macros:r,once:!0})}),e<this.progress&&this.track("rewind",{macros:r})}this.progress=e}},{key:"isQuartileReached",value:function(e,t,r){var i=!1;return t<=r&&!this._alreadyTriggeredQuartiles[e]&&(i=!0),i}},{key:"setMuted",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.muted!==e&&this.track(e?"mute":"unmute",{macros:t}),this.muted=e}},{key:"setPaused",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.paused!==e&&this.track(e?"pause":"resume",{macros:t}),this.paused=e}},{key:"setFullscreen",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.fullscreen!==e&&this.track(e?"fullscreen":"exitFullscreen",{macros:t}),this.fullscreen=e}},{key:"setExpand",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.expanded!==e&&(this.track(e?"expand":"collapse",{macros:t}),this.track(e?"playerExpand":"playerCollapse",{macros:t})),this.expanded=e}},{key:"setSkipDelay",value:function(e){"number"==typeof e&&(this.skipDelay=e)}},{key:"trackImpression",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.impressed||(this.impressed=!0,this.trackURLs(this.ad.impressionURLTemplates),this.track("creativeView",{macros:e}))}},{key:"errorWithCode",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.trackURLs(this.ad.errorURLTemplates,{ERRORCODE:e},{isCustomCode:t})}},{key:"complete",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("complete",{macros:e})}},{key:"notUsed",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("notUsed",{macros:e}),this.trackingEvents=[]}},{key:"otherAdInteraction",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("otherAdInteraction",{macros:e})}},{key:"acceptInvitation",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("acceptInvitation",{macros:e})}},{key:"adExpand",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("adExpand",{macros:e})}},{key:"adCollapse",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("adCollapse",{macros:e})}},{key:"minimize",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("minimize",{macros:e})}},{key:"verificationNotExecuted",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(!this.ad||!this.ad.adVerifications||!this.ad.adVerifications.length)throw new Error("No adVerifications provided");if(!t)throw new Error("No vendor provided, unable to find associated verificationNotExecuted");var r=this.ad.adVerifications.find(function(e){return e.vendor===t});if(!r)throw new Error("No associated verification element found for vendor: ".concat(t));var i=r.trackingEvents;if(i&&i.verificationNotExecuted){var a=i.verificationNotExecuted;this.trackURLs(a,e),this.emit("verificationNotExecuted",{trackingURLTemplates:a})}}},{key:"overlayViewDuration",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};t.CONTENTPLAYHEAD=e,t.MEDIAPLAYHEAD=t.ADPLAYHEAD=t.CONTENTPLAYHEAD,this.track("overlayViewDuration",{macros:t})}},{key:"close",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track(this.linear?"closeLinear":"close",{macros:e})}},{key:"skip",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("skip",{macros:e})}},{key:"load",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.track("loaded",{macros:e})}},{key:"click",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.clickTrackingURLTemplates&&this.clickTrackingURLTemplates.length&&this.trackURLs(this.clickTrackingURLTemplates,t);var r=this.clickThroughURLTemplate||e;if(r){this.linear&&(t.CONTENTPLAYHEAD=this.progressFormatted(),t.MEDIAPLAYHEAD=t.ADPLAYHEAD=t.CONTENTPLAYHEAD);var i=util.resolveURLTemplates([r],t)[0];this.emit("clickthrough",i)}}},{key:"track",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=t.macros,i=void 0===r?{}:r,a=t.once,n=void 0!==a&&a;"closeLinear"===e&&!this.trackingEvents[e]&&this.trackingEvents.close&&(e="close");var s=this.trackingEvents[e],o=-1<this.emitAlwaysEvents.indexOf(e);s?(this.emit(e,{trackingURLTemplates:s}),this.trackURLs(s,i)):o&&this.emit(e,null),n&&(delete this.trackingEvents[e],o&&this.emitAlwaysEvents.splice(this.emitAlwaysEvents.indexOf(e),1))}},{key:"trackURLs",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};this.linear&&(this.creative&&this.creative.mediaFiles&&this.creative.mediaFiles[0]&&this.creative.mediaFiles[0].fileURL&&(t.ASSETURI=this.creative.mediaFiles[0].fileURL),!t.CONTENTPLAYHEAD&&this.progress&&(t.CONTENTPLAYHEAD=this.progressFormatted(),t.MEDIAPLAYHEAD=t.ADPLAYHEAD=t.CONTENTPLAYHEAD)),this.creative&&this.creative.universalAdId&&this.creative.universalAdId.idRegistry&&this.creative.universalAdId.value&&(t.UNIVERSALADID="".concat(this.creative.universalAdId.idRegistry," ").concat(this.creative.universalAdId.value)),this.ad&&(this.ad.sequence&&(t.PODSEQUENCE=this.ad.sequence),this.ad.adType&&(t.ADTYPE=this.ad.adType),this.ad.adServingId&&(t.ADSERVINGID=this.ad.adServingId),this.ad.categories&&this.ad.categories.length&&(t.ADCATEGORIES=this.ad.categories.map(function(e){return e.value}).join(","))),util.track(e,t,r)}},{key:"progressFormatted",value:function(){var e=parseInt(this.progress),t=e/3600;t.length<2&&(t="0".concat(t));var r=e/60%60;r.length<2&&(r="0".concat(r));var i=e%60;i.length<2&&(i="0".concat(r));var a=parseInt(100*(this.progress-e));return"".concat(t,":").concat(r,":").concat(i,".").concat(a)}}]),o}();exports.VASTClient=VASTClient,exports.VASTParser=VASTParser,exports.VASTTracker=VASTTracker;
