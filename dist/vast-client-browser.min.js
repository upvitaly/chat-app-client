var VAST=function(e){"use strict";function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}var o=function e(){l(this,e),this.id=null,this.sequence=null,this.system=null,this.title=null,this.description=null,this.advertiser=null,this.pricing=null,this.survey=null,this.errorURLTemplates=[],this.impressionURLTemplates=[],this.creatives=[],this.extensions=[],this.adVerifications=[]},h=function(){function e(){l(this,e),this.name=null,this.value=null,this.attributes={},this.children=[]}return n(e,[{key:"isEmpty",value:function(){return null===this.value&&0===Object.keys(this.attributes).length&&0===this.children.length}}]),e}(),p=function e(){l(this,e),this.resource=null,this.vendor=null,this.browserOptional=!1,this.apiFramework=null,this.parameters=null},d=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};l(this,e),this.id=t.id||null,this.width=t.width||0,this.height=t.height||0,this.assetWidth=t.assetWidth||null,this.assetHeight=t.assetHeight||null,this.expandedWidth=t.expandedWidth||null,this.expandedHeight=t.expandedHeight||null,this.apiFramework=t.apiFramework||null,this.adSlotID=t.adSlotID||null,this.staticResources=[],this.htmlResources=[],this.iframeResources=[],this.adParameters=null,this.xmlEncoded=null,this.altText=null,this.companionClickThroughURLTemplate=null,this.companionClickTrackingURLTemplates=[],this.trackingEvents={}},t=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};l(this,e),this.id=t.id||null,this.adId=t.adId||null,this.sequence=t.sequence||null,this.apiFramework=t.apiFramework||null},v=function(e){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,i),(e=u(this,c(i).call(this,t))).type="companion",e.required=null,e.variations=[],e}return a(i,t),i}();function f(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=[];for(var n in t.ASSETURI&&(t.ASSETURI=m(t.ASSETURI)),t.CONTENTPLAYHEAD&&(t.CONTENTPLAYHEAD=m(t.CONTENTPLAYHEAD)),!t.ERRORCODE||i.isCustomCode||/^[0-9]{3}$/.test(t.ERRORCODE)||(t.ERRORCODE=900),t.CACHEBUSTING=g(Math.round(1e8*Math.random()).toString()),t.TIMESTAMP=m((new Date).toISOString()),t.RANDOM=t.random=t.CACHEBUSTING,e){var a=e[n];if("string"==typeof a){for(var s in t){var o=t[s],l="[".concat(s,"]"),c="%%".concat(s,"%%");a=(a=a.replace(l,o)).replace(c,o)}r.push(a)}}return r}function m(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%".concat(e.charCodeAt(0).toString(16))})}function g(e){return e.length<8?T(0,8-e.length,!1).map(function(){return"0"}).join("")+e:e}function T(e,t,i){for(var r=[],n=e<t,a=i?n?t+1:t-1:t,s=e;n?s<a:a<s;n?s++:s--)r.push(s);return r}var k={track:function(e,t,i){f(e,t,i).forEach(function(e){"undefined"!=typeof window&&null!==window&&((new Image).src=e)})},resolveURLTemplates:f,encodeURIComponentRFC3986:m,leftpad:g,range:T,isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},flatten:function i(e){return e.reduce(function(e,t){return e.concat(Array.isArray(t)?i(t):t)},[])},joinArrayUnique:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],i=Array.isArray(e)?e:[],r=Array.isArray(t)?t:[];return i.concat(r).reduce(function(e,t){return-1===e.indexOf(t)&&e.push(t),e},[])}};function y(e){return-1!==["true","TRUE","1"].indexOf(e)}var R={childByName:function(e,t){var i=e.childNodes;for(var r in i){var n=i[r];if(n.nodeName===t)return n}},childrenByName:function(e,t){var i=[],r=e.childNodes;for(var n in r){var a=r[n];a.nodeName===t&&i.push(a)}return i},resolveVastAdTagURI:function(e,t){if(!t)return e;if(0===e.indexOf("//")){var i=location.protocol;return"".concat(i).concat(e)}if(-1!==e.indexOf("://"))return e;var r=t.slice(0,t.lastIndexOf("/"));return"".concat(r,"/").concat(e)},parseBoolean:y,parseNodeText:function(e){return e&&(e.textContent||e.text||"").trim()},copyNodeAttribute:function(e,t,i){var r=t.getAttribute(e);r&&i.setAttribute(e,r)},parseAttributes:function(e){for(var t=e.attributes,i={},r=0;r<t.length;r++)i[t[r].nodeName]=t[r].nodeValue;return i},parseDuration:function(e){if(null==e)return-1;if(k.isNumeric(e))return parseInt(e);var t=e.split(":");if(3!==t.length)return-1;var i=t[2].split("."),r=parseInt(i[0]);2===i.length&&(r+=parseFloat("0.".concat(i[1])));var n=parseInt(60*t[1]),a=parseInt(60*t[0]*60);return isNaN(a)||isNaN(n)||isNaN(r)||3600<n||60<r?-1:a+n+r},splitVAST:function(r){var n=[],a=null;return r.forEach(function(e,t){if(e.sequence&&(e.sequence=parseInt(e.sequence,10)),1<e.sequence){var i=r[t-1];if(i&&i.sequence===e.sequence-1)return void(a&&a.push(e));delete e.sequence}a=[e],n.push(a)}),n},assignAttributes:function(e,t){if(e)for(var i in e){var r=e[i];if(r.nodeName&&r.nodeValue&&t.hasOwnProperty(r.nodeName)){var n=r.nodeValue;"boolean"==typeof t[r.nodeName]&&(n=y(n)),t[r.nodeName]=n}}},mergeWrapperAdData:function(e,r){e.errorURLTemplates=r.errorURLTemplates.concat(e.errorURLTemplates),e.impressionURLTemplates=r.impressionURLTemplates.concat(e.impressionURLTemplates),e.extensions=r.extensions.concat(e.extensions);var t=(r.creatives||[]).filter(function(e){return e&&"companion"===e.type}),n=t.reduce(function(t,e){return(e.variations||[]).forEach(function(e){(e.companionClickTrackingURLTemplates||[]).forEach(function(e){-1===t.indexOf(e)&&t.push(e)})}),t},[]);e.creatives=t.concat(e.creatives);var a=r.videoClickTrackingURLTemplates&&r.videoClickTrackingURLTemplates.length,s=r.videoCustomClickURLTemplates&&r.videoCustomClickURLTemplates.length;e.creatives.forEach(function(e){if(r.trackingEvents&&r.trackingEvents[e.type])for(var t in r.trackingEvents[e.type]){var i=r.trackingEvents[e.type][t];Array.isArray(e.trackingEvents[t])||(e.trackingEvents[t]=[]),e.trackingEvents[t]=e.trackingEvents[t].concat(i)}"linear"===e.type&&(a&&(e.videoClickTrackingURLTemplates=e.videoClickTrackingURLTemplates.concat(r.videoClickTrackingURLTemplates)),s&&(e.videoCustomClickURLTemplates=e.videoCustomClickURLTemplates.concat(r.videoCustomClickURLTemplates)),!r.videoClickThroughURLTemplate||null!==e.videoClickThroughURLTemplate&&void 0!==e.videoClickThroughURLTemplate||(e.videoClickThroughURLTemplate=r.videoClickThroughURLTemplate)),"companion"===e.type&&n.length&&(e.variations||[]).forEach(function(e){e.companionClickTrackingURLTemplates=k.joinArrayUnique(e.companionClickTrackingURLTemplates,n)})})}};var A=function(e){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,i),(e=u(this,c(i).call(this,t))).type="linear",e.duration=0,e.skipDelay=null,e.mediaFiles=[],e.mezzanine=null,e.videoClickThroughURLTemplate=null,e.videoClickTrackingURLTemplates=[],e.videoCustomClickURLTemplates=[],e.adParameters=null,e.icons=[],e.trackingEvents={},e}return a(i,t),i}(),L=function e(){l(this,e),this.program=null,this.height=0,this.width=0,this.xPosition=0,this.yPosition=0,this.apiFramework=null,this.offset=null,this.duration=0,this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.iconClickThroughURLTemplate=null,this.iconClickTrackingURLTemplates=[],this.iconViewTrackingURLTemplate=null},U=function e(){l(this,e),this.id=null,this.fileURL=null,this.deliveryType="progressive",this.mimeType=null,this.codec=null,this.bitrate=0,this.minBitrate=0,this.maxBitrate=0,this.width=0,this.height=0,this.apiFramework=null,this.scalable=null,this.maintainAspectRatio=null},E=function e(){l(this,e),this.id=null,this.fileURL=null,this.delivery=null,this.codec=null,this.type=null,this.width=0,this.height=0,this.fileSize=0,this.mediaType="2D"};function b(e,t){var r,o=new A(t);o.duration=R.parseDuration(R.parseNodeText(R.childByName(e,"Duration")));var i=e.getAttribute("skipoffset");if(null==i)o.skipDelay=null;else if("%"===i.charAt(i.length-1)&&-1!==o.duration){var n=parseInt(i,10);o.skipDelay=o.duration*(n/100)}else o.skipDelay=R.parseDuration(i);var a=R.childByName(e,"VideoClicks");a&&(o.videoClickThroughURLTemplate=R.parseNodeText(R.childByName(a,"ClickThrough")),R.childrenByName(a,"ClickTracking").forEach(function(e){o.videoClickTrackingURLTemplates.push(R.parseNodeText(e))}),R.childrenByName(a,"CustomClick").forEach(function(e){o.videoCustomClickURLTemplates.push(R.parseNodeText(e))}));var s=R.childByName(e,"AdParameters");s&&(o.adParameters=R.parseNodeText(s)),R.childrenByName(e,"TrackingEvents").forEach(function(e){R.childrenByName(e,"Tracking").forEach(function(e){var t=e.getAttribute("event"),i=R.parseNodeText(e);if(t&&i){if("progress"===t){if(!(r=e.getAttribute("offset")))return;t="%"===r.charAt(r.length-1)?"progress-".concat(r):"progress-".concat(Math.round(R.parseDuration(r)))}Array.isArray(o.trackingEvents[t])||(o.trackingEvents[t]=[]),o.trackingEvents[t].push(i)}})}),R.childrenByName(e,"MediaFiles").forEach(function(e){R.childrenByName(e,"MediaFile").forEach(function(e){var t=new U;t.id=e.getAttribute("id"),t.fileURL=R.parseNodeText(e),t.deliveryType=e.getAttribute("delivery"),t.codec=e.getAttribute("codec"),t.mimeType=e.getAttribute("type"),t.apiFramework=e.getAttribute("apiFramework"),t.bitrate=parseInt(e.getAttribute("bitrate")||0),t.minBitrate=parseInt(e.getAttribute("minBitrate")||0),t.maxBitrate=parseInt(e.getAttribute("maxBitrate")||0),t.width=parseInt(e.getAttribute("width")||0),t.height=parseInt(e.getAttribute("height")||0);var i=e.getAttribute("scalable");i&&"string"==typeof i&&("true"===(i=i.toLowerCase())?t.scalable=!0:"false"===i&&(t.scalable=!1));var r=e.getAttribute("maintainAspectRatio");r&&"string"==typeof r&&("true"===(r=r.toLowerCase())?t.maintainAspectRatio=!0:"false"===r&&(t.maintainAspectRatio=!1)),o.mediaFiles.push(t)});var t,i,r,n=R.childByName(e,"Mezzanine"),a=(t=n,r=!(i={}),["delivery","type","width","height"].forEach(function(e){t&&t.getAttribute(e)?i[e]=t.getAttribute(e):r=!0}),r?null:i);if(a){var s=new E;s.id=n.getAttribute("id"),s.fileURL=R.parseNodeText(n),s.delivery=a.delivery,s.codec=n.getAttribute("codec"),s.type=a.type,s.width=parseInt(a.width,10),s.height=parseInt(a.height,10),s.fileSize=parseInt(n.getAttribute("fileSize"),10),s.mediaType=n.getAttribute("mediaType")||"2D",o.mezzanine=s}});var l=R.childByName(e,"Icons");return l&&R.childrenByName(l,"Icon").forEach(function(e){var t,i,r=new L;r.program=e.getAttribute("program"),r.height=parseInt(e.getAttribute("height")||0),r.width=parseInt(e.getAttribute("width")||0),r.xPosition=(t=e.getAttribute("xPosition"),-1===["left","right"].indexOf(t)?parseInt(t||0):t),r.yPosition=(i=e.getAttribute("yPosition"),-1===["top","bottom"].indexOf(i)?parseInt(i||0):i),r.apiFramework=e.getAttribute("apiFramework"),r.offset=R.parseDuration(e.getAttribute("offset")),r.duration=R.parseDuration(e.getAttribute("duration")),R.childrenByName(e,"HTMLResource").forEach(function(e){r.type=e.getAttribute("creativeType")||"text/html",r.htmlResource=R.parseNodeText(e)}),R.childrenByName(e,"IFrameResource").forEach(function(e){r.type=e.getAttribute("creativeType")||0,r.iframeResource=R.parseNodeText(e)}),R.childrenByName(e,"StaticResource").forEach(function(e){r.type=e.getAttribute("creativeType")||0,r.staticResource=R.parseNodeText(e)});var n=R.childByName(e,"IconClicks");n&&(r.iconClickThroughURLTemplate=R.parseNodeText(R.childByName(n,"IconClickThrough")),R.childrenByName(n,"IconClickTracking").forEach(function(e){r.iconClickTrackingURLTemplates.push(R.parseNodeText(e))})),r.iconViewTrackingURLTemplate=R.parseNodeText(R.childByName(e,"IconViewTracking")),o.icons.push(r)}),o}var N=function(e){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,i),(e=u(this,c(i).call(this,t))).type="nonlinear",e.variations=[],e.trackingEvents={},e}return a(i,t),i}(),w=function e(){l(this,e),this.id=null,this.width=0,this.height=0,this.expandedWidth=0,this.expandedHeight=0,this.scalable=!0,this.maintainAspectRatio=!0,this.minSuggestedDuration=0,this.apiFramework="static",this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.nonlinearClickThroughURLTemplate=null,this.nonlinearClickTrackingURLTemplates=[],this.adParameters=null};function C(e,t){var r=new N(t);return R.childrenByName(e,"TrackingEvents").forEach(function(e){var t,i;R.childrenByName(e,"Tracking").forEach(function(e){t=e.getAttribute("event"),i=R.parseNodeText(e),t&&i&&(Array.isArray(r.trackingEvents[t])||(r.trackingEvents[t]=[]),r.trackingEvents[t].push(i))})}),R.childrenByName(e,"NonLinear").forEach(function(e){var t=new w;t.id=e.getAttribute("id")||null,t.width=e.getAttribute("width"),t.height=e.getAttribute("height"),t.expandedWidth=e.getAttribute("expandedWidth"),t.expandedHeight=e.getAttribute("expandedHeight"),t.scalable=R.parseBoolean(e.getAttribute("scalable")),t.maintainAspectRatio=R.parseBoolean(e.getAttribute("maintainAspectRatio")),t.minSuggestedDuration=R.parseDuration(e.getAttribute("minSuggestedDuration")),t.apiFramework=e.getAttribute("apiFramework"),R.childrenByName(e,"HTMLResource").forEach(function(e){t.type=e.getAttribute("creativeType")||"text/html",t.htmlResource=R.parseNodeText(e)}),R.childrenByName(e,"IFrameResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.iframeResource=R.parseNodeText(e)}),R.childrenByName(e,"StaticResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.staticResource=R.parseNodeText(e)});var i=R.childByName(e,"AdParameters");i&&(t.adParameters=R.parseNodeText(i)),t.nonlinearClickThroughURLTemplate=R.parseNodeText(R.childByName(e,"NonLinearClickThrough")),R.childrenByName(e,"NonLinearClickTracking").forEach(function(e){t.nonlinearClickTrackingURLTemplates.push(R.parseNodeText(e))}),r.variations.push(t)}),r}function x(e){var t=e.childNodes;for(var i in t){var r=t[i];if(-1!==["Wrapper","InLine"].indexOf(r.nodeName)){if(R.copyNodeAttribute("id",e,r),R.copyNodeAttribute("sequence",e,r),"Wrapper"===r.nodeName)return I(r);if("InLine"===r.nodeName)return S(r)}}}function S(e){var t=e.childNodes,l=new o;for(var i in l.id=e.getAttribute("id")||null,l.sequence=e.getAttribute("sequence")||null,t){var r=t[i];switch(r.nodeName){case"Error":l.errorURLTemplates.push(R.parseNodeText(r));break;case"Impression":l.impressionURLTemplates.push(R.parseNodeText(r));break;case"Creatives":R.childrenByName(r,"Creative").forEach(function(e){var t,i,r,n={id:e.getAttribute("id")||null,adId:(t=e,t.getAttribute("AdID")||t.getAttribute("adID")||t.getAttribute("adId")||null),sequence:e.getAttribute("sequence")||null,apiFramework:e.getAttribute("apiFramework")||null};for(var a in e.childNodes){var s=e.childNodes[a],o=void 0;switch(s.nodeName){case"Linear":(o=b(s,n))&&l.creatives.push(o);break;case"NonLinearAds":(o=C(s,n))&&l.creatives.push(o);break;case"CompanionAds":i=s,r=void 0,(r=new v(n)).required=i.getAttribute("required")||null,r.variations=R.childrenByName(i,"Companion").map(function(e){var r=new d(R.parseAttributes(e));r.htmlResources=R.childrenByName(e,"HTMLResource").reduce(function(e,t){var i=R.parseNodeText(t);return i?e.concat(i):e},[]),r.iframeResources=R.childrenByName(e,"IFrameResource").reduce(function(e,t){var i=R.parseNodeText(t);return i?e.concat(i):e},[]),r.staticResources=R.childrenByName(e,"StaticResource").reduce(function(e,t){var i=R.parseNodeText(t);return i?e.concat({url:i,creativeType:t.getAttribute("creativeType")||null}):e},[]),r.altText=R.parseNodeText(R.childByName(e,"AltText"))||null;var t=R.childByName(e,"TrackingEvents");t&&R.childrenByName(t,"Tracking").forEach(function(e){var t=e.getAttribute("event"),i=R.parseNodeText(e);t&&i&&(Array.isArray(r.trackingEvents[t])||(r.trackingEvents[t]=[]),r.trackingEvents[t].push(i))}),r.companionClickTrackingURLTemplates=R.childrenByName(e,"CompanionClickTracking").map(function(e){return R.parseNodeText(e)}),r.companionClickThroughURLTemplate=R.parseNodeText(R.childByName(e,"CompanionClickThrough"))||null;var i=R.childByName(e,"AdParameters");return i&&(r.adParameters=R.parseNodeText(i),r.xmlEncoded=i.getAttribute("xmlEncoded")||null),r}),(o=r)&&l.creatives.push(o)}}});break;case"Extensions":l.extensions=D(R.childrenByName(r,"Extension"));break;case"AdVerifications":l.adVerifications=O(R.childrenByName(r,"Verification"));break;case"AdSystem":l.system={value:R.parseNodeText(r),version:r.getAttribute("version")||null};break;case"AdTitle":l.title=R.parseNodeText(r);break;case"Description":l.description=R.parseNodeText(r);break;case"Advertiser":l.advertiser=R.parseNodeText(r);break;case"Pricing":l.pricing={value:R.parseNodeText(r),model:r.getAttribute("model")||null,currency:r.getAttribute("currency")||null};break;case"Survey":l.survey=R.parseNodeText(r)}}return l}function I(e){var r=S(e),t=R.childByName(e,"VASTAdTagURI");if(t?r.nextWrapperURL=R.parseNodeText(t):(t=R.childByName(e,"VASTAdTagURL"))&&(r.nextWrapperURL=R.parseNodeText(R.childByName(t,"URL"))),r.creatives.forEach(function(i){if(-1!==["linear","nonlinear"].indexOf(i.type)){if(i.trackingEvents){r.trackingEvents||(r.trackingEvents={}),r.trackingEvents[i.type]||(r.trackingEvents[i.type]={});var e=function(t){var e=i.trackingEvents[t];Array.isArray(r.trackingEvents[i.type][t])||(r.trackingEvents[i.type][t]=[]),e.forEach(function(e){r.trackingEvents[i.type][t].push(e)})};for(var t in i.trackingEvents)e(t)}i.videoClickTrackingURLTemplates&&(Array.isArray(r.videoClickTrackingURLTemplates)||(r.videoClickTrackingURLTemplates=[]),i.videoClickTrackingURLTemplates.forEach(function(e){r.videoClickTrackingURLTemplates.push(e)})),i.videoClickThroughURLTemplate&&(r.videoClickThroughURLTemplate=i.videoClickThroughURLTemplate),i.videoCustomClickURLTemplates&&(Array.isArray(r.videoCustomClickURLTemplates)||(r.videoCustomClickURLTemplates=[]),i.videoCustomClickURLTemplates.forEach(function(e){r.videoCustomClickURLTemplates.push(e)}))}}),r.nextWrapperURL)return r}function D(e){var i=[];return e.forEach(function(e){var t=function e(t){if("#comment"===t.nodeName)return null;var i=new h;var r=t.attributes;var n=t.childNodes;i.name=t.nodeName;if(t.attributes)for(var a in r)if(r.hasOwnProperty(a)){var s=r[a];s.nodeName&&s.nodeValue&&(i.attributes[s.nodeName]=s.nodeValue)}for(var o in n)if(n.hasOwnProperty(o)){var l=e(n[o]);l&&i.children.push(l)}if(0===i.children.length||1===i.children.length&&0<=["#cdata-section","#text"].indexOf(i.children[0].name)){var c=R.parseNodeText(t);""!==c&&(i.value=c),i.children=[]}return i.isEmpty()?null:i}(e);t&&i.push(t)}),i}function O(e){var a=[];return e.forEach(function(e){var t=new p,i=e.childNodes;for(var r in R.assignAttributes(e.attributes,t),i){var n=i[r];switch(n.nodeName){case"JavaScriptResource":t.resource=R.parseNodeText(n),R.assignAttributes(n.attributes,t);break;case"VerificationParameters":t.parameters=R.parseNodeText(n)}}a.push(t)}),a}var V=function(){function e(){l(this,e),this._handlers=[]}return n(e,[{key:"on",value:function(e,t){if("function"!=typeof t)throw new TypeError("The handler argument must be of type Function. Received type ".concat(i(t)));if(!e)throw new TypeError("The event argument must be of type String. Received type ".concat(i(e)));return this._handlers.push({event:e,handler:t}),this}},{key:"once",value:function(e,t){return this.on(e,function(e,t,i){var r={fired:!1,wrapFn:void 0};function n(){r.fired||(e.off(t,r.wrapFn),r.fired=!0,i.bind(e).apply(void 0,arguments))}return r.wrapFn=n}(this,e,t))}},{key:"off",value:function(t,i){return this._handlers=this._handlers.filter(function(e){return e.event!==t||e.handler!==i}),this}},{key:"emit",value:function(t){for(var e=arguments.length,i=new Array(1<e?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];var n=!1;return this._handlers.forEach(function(e){"*"===e.event&&(n=!0,e.handler.apply(e,[t].concat(i))),e.event===t&&(n=!0,e.handler.apply(e,i))}),n}},{key:"removeAllListeners",value:function(t){return this._handlers=t?this._handlers.filter(function(e){return e.event!==t}):[],this}},{key:"listenerCount",value:function(t){return this._handlers.filter(function(e){return e.event===t}).length}},{key:"listeners",value:function(i){return this._handlers.reduce(function(e,t){return t.event===i&&e.push(t.handler),e},[])}},{key:"eventNames",value:function(){return this._handlers.map(function(e){return e.event})}}]),e}();function B(){var e;return window.XDomainRequest&&(e=new XDomainRequest),e}var P={get:function(e,t,i){var r="function"==typeof window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLDOM"):void 0;if(!r)return i(new Error("FlashURLHandler: Microsoft.XMLDOM format not supported"));r.async=!1;var n=B();n.open("GET",e),n.timeout=t.timeout||0,n.withCredentials=t.withCredentials||!1,n.send(),n.onprogress=function(){},n.onload=function(){r.loadXML(n.responseText),i(null,r)}},supported:function(){return!!B()}};var F={get:function(e,t,i){i(new Error("Please bundle the library for node to use the node urlHandler"))}};function M(){try{var e=new window.XMLHttpRequest;return"withCredentials"in e?e:null}catch(e){return null}}var H={get:function(e,t,i){if("https:"===window.location.protocol&&0===e.indexOf("http://"))return i(new Error("XHRURLHandler: Cannot go from HTTPS to HTTP."));try{var r=M();r.open("GET",e),r.timeout=t.timeout||0,r.withCredentials=t.withCredentials||!1,r.overrideMimeType&&r.overrideMimeType("text/xml"),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?i(null,r.responseXML):i(new Error("XHRURLHandler: ".concat(r.statusText))))},r.send()}catch(e){i(new Error("XHRURLHandler: Unexpected error"))}},supported:function(){return!!M()}};var q={get:function(e,t,i){return i||("function"==typeof t&&(i=t),t={}),"undefined"==typeof window||null===window?F.get(e,t,i):H.supported()?H.get(e,t,i):P.supported()?P.get(e,t,i):i(new Error("Current context is not supported by any of the default URLHandlers. Please provide a custom URLHandler"))}},W=function e(){l(this,e),this.ads=[],this.errorURLTemplates=[],this.version=null},_={ERRORCODE:900,extensions:[]},j=function(e){function t(){var e;return l(this,t),(e=u(this,c(t).call(this))).remainingAds=[],e.parentURLs=[],e.errorURLTemplates=[],e.rootErrorURLTemplates=[],e.maxWrapperDepth=null,e.URLTemplateFilters=[],e.fetchingOptions={},e}return a(t,V),n(t,[{key:"addURLTemplateFilter",value:function(e){"function"==typeof e&&this.URLTemplateFilters.push(e)}},{key:"removeURLTemplateFilter",value:function(){this.URLTemplateFilters.pop()}},{key:"countURLTemplateFilters",value:function(){return this.URLTemplateFilters.length}},{key:"clearURLTemplateFilters",value:function(){this.URLTemplateFilters=[]}},{key:"trackVastError",value:function(e,t){for(var i=arguments.length,r=new Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];this.emit("VAST-error",Object.assign.apply(Object,[_,t].concat(r))),k.track(e,t)}},{key:"getErrorURLTemplates",value:function(){return this.rootErrorURLTemplates.concat(this.errorURLTemplates)}},{key:"fetchVAST",value:function(n,e,t){var a=this;return new Promise(function(i,r){a.URLTemplateFilters.forEach(function(e){n=e(n)}),a.parentURLs.push(n),a.emit("VAST-resolving",{url:n,wrapperDepth:e,originalUrl:t}),a.urlHandler.get(n,a.fetchingOptions,function(e,t){a.emit("VAST-resolved",{url:n,error:e}),e?r(e):i(t)})})}},{key:"initParsingStatus",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.rootURL="",this.remainingAds=[],this.parentURLs=[],this.errorURLTemplates=[],this.rootErrorURLTemplates=[],this.maxWrapperDepth=e.wrapperLimit||10,this.fetchingOptions={timeout:e.timeout,withCredentials:e.withCredentials},this.urlHandler=e.urlHandler||e.urlhandler||q,this.vastVersion=null}},{key:"getRemainingAds",value:function(e){var t=this;if(0===this.remainingAds.length)return Promise.reject(new Error("No more ads are available for the given VAST"));var i=e?k.flatten(this.remainingAds):this.remainingAds.shift();return this.errorURLTemplates=[],this.parentURLs=[],this.resolveAds(i,{wrapperDepth:0,originalUrl:this.rootURL}).then(function(e){return t.buildVASTResponse(e)})}},{key:"getAndParseVAST",value:function(t){var i=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(r),this.rootURL=t,this.fetchVAST(t).then(function(e){return r.originalUrl=t,r.isRootVAST=!0,i.parse(e,r).then(function(e){return i.buildVASTResponse(e)})})}},{key:"parseVAST",value:function(e){var t=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(i),i.isRootVAST=!0,this.parse(e,i).then(function(e){return t.buildVASTResponse(e)})}},{key:"buildVASTResponse",value:function(e){var t=new W;return t.ads=e,t.errorURLTemplates=this.getErrorURLTemplates(),t.version=this.vastVersion,this.completeWrapperResolving(t),t}},{key:"parseVastXml",value:function(e,t){var i=t.isRootVAST,r=void 0!==i&&i;if(!e||!e.documentElement||"VAST"!==e.documentElement.nodeName)throw new Error("Invalid VAST XMLDocument");var n=[],a=e.documentElement.childNodes;if(r){var s=e.documentElement.getAttribute("version");s&&(this.vastVersion=s)}for(var o in a){var l=a[o];if("Error"===l.nodeName){var c=R.parseNodeText(l);r?this.rootErrorURLTemplates.push(c):this.errorURLTemplates.push(c)}if("Ad"===l.nodeName){var u=x(l);u?n.push(u):this.trackVastError(this.getErrorURLTemplates(),{ERRORCODE:101})}}return n}},{key:"parse",value:function(e,t){var i=t.resolveAll,r=void 0===i||i,n=t.wrapperSequence,a=void 0===n?null:n,s=t.originalUrl,o=void 0===s?null:s,l=t.wrapperDepth,c=void 0===l?0:l,u=t.isRootVAST,h=void 0!==u&&u,p=[];try{p=this.parseVastXml(e,{isRootVAST:h})}catch(e){return Promise.reject(e)}var d=p.length,v=p[d-1];return 1===d&&null!=a&&v&&!v.sequence&&(v.sequence=a),!1===r&&(this.remainingAds=R.splitVAST(p),p=this.remainingAds.shift()),this.resolveAds(p,{wrapperDepth:c,originalUrl:o})}},{key:"resolveAds",value:function(){var r=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length?arguments[1]:void 0,n=t.wrapperDepth,a=t.originalUrl,i=[];return e.forEach(function(e){var t=r.resolveWrappers(e,n,a);i.push(t)}),Promise.all(i).then(function(e){var t=k.flatten(e);if(!t&&0<r.remainingAds.length){var i=r.remainingAds.shift();return r.resolveAds(i,{wrapperDepth:n,originalUrl:a})}return t})}},{key:"resolveWrappers",value:function(r,n,a){var s=this;return new Promise(function(t){if(n++,!r.nextWrapperURL)return delete r.nextWrapperURL,t(r);if(n>=s.maxWrapperDepth||-1!==s.parentURLs.indexOf(r.nextWrapperURL))return r.errorCode=302,delete r.nextWrapperURL,t(r);r.nextWrapperURL=R.resolveVastAdTagURI(r.nextWrapperURL,a);var i=r.sequence;a=r.nextWrapperURL,s.fetchVAST(r.nextWrapperURL,n,a).then(function(e){return s.parse(e,{originalUrl:a,wrapperSequence:i,wrapperDepth:n}).then(function(e){if(delete r.nextWrapperURL,0===e.length)return r.creatives=[],t(r);e.forEach(function(e){e&&R.mergeWrapperAdData(e,r)}),t(e)})}).catch(function(e){r.errorCode=301,r.errorMessage=e.message,t(r)})})}},{key:"completeWrapperResolving",value:function(e){if(0===e.ads.length)this.trackVastError(e.errorURLTemplates,{ERRORCODE:303});else for(var t=e.ads.length-1;0<=t;t--){var i=e.ads[t];(i.errorCode||0===i.creatives.length)&&(this.trackVastError(i.errorURLTemplates.concat(e.errorURLTemplates),{ERRORCODE:i.errorCode||303},{ERRORMESSAGE:i.errorMessage||""},{extensions:i.extensions},{system:i.system}),e.ads.splice(t,1))}}}]),t}(),X=null,z={data:{},length:0,getItem:function(e){return this.data[e]},setItem:function(e,t){this.data[e]=t,this.length=Object.keys(this.data).length},removeItem:function(e){delete this.data[e],this.length=Object.keys(this.data).length},clear:function(){this.data={},this.length=0}},Q=function(){function e(){l(this,e),this.storage=this.initStorage()}return n(e,[{key:"initStorage",value:function(){if(X)return X;try{X="undefined"!=typeof window&&null!==window?window.localStorage||window.sessionStorage:null}catch(e){X=null}return X&&!this.isStorageDisabled(X)||(X=z).clear(),X}},{key:"isStorageDisabled",value:function(e){var t="__VASTStorage__";try{if(e.setItem(t,t),e.getItem(t)!==t)return e.removeItem(t),!0}catch(e){return!0}return e.removeItem(t),!1}},{key:"getItem",value:function(e){return this.storage.getItem(e)}},{key:"setItem",value:function(e,t){return this.storage.setItem(e,t)}},{key:"removeItem",value:function(e){return this.storage.removeItem(e)}},{key:"clear",value:function(){return this.storage.clear()}}]),e}(),G=function(){function r(e,t,i){l(this,r),this.cappingFreeLunch=e||0,this.cappingMinimumTimeInterval=t||0,this.defaultOptions={withCredentials:!1,timeout:0},this.vastParser=new j,this.storage=i||new Q,void 0===this.lastSuccessfulAd&&(this.lastSuccessfulAd=0),void 0===this.totalCalls&&(this.totalCalls=0),void 0===this.totalCallsTimeout&&(this.totalCallsTimeout=0)}return n(r,[{key:"getParser",value:function(){return this.vastParser}},{key:"hasRemainingAds",value:function(){return 0<this.vastParser.remainingAds.length}},{key:"getNextAds",value:function(e){return this.vastParser.getRemainingAds(e)}},{key:"get",value:function(r){var n=this,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s=Date.now();return(a=Object.assign(this.defaultOptions,a)).hasOwnProperty("resolveAll")||(a.resolveAll=!1),this.totalCallsTimeout<s?(this.totalCalls=1,this.totalCallsTimeout=s+36e5):this.totalCalls++,new Promise(function(t,i){if(n.cappingFreeLunch>=n.totalCalls)return i(new Error("VAST call canceled – FreeLunch capping not reached yet ".concat(n.totalCalls,"/").concat(n.cappingFreeLunch)));var e=s-n.lastSuccessfulAd;if(e<0)n.lastSuccessfulAd=0;else if(e<n.cappingMinimumTimeInterval)return i(new Error("VAST call canceled – (".concat(n.cappingMinimumTimeInterval,")ms minimum interval reached")));n.vastParser.getAndParseVAST(r,a).then(function(e){return t(e)}).catch(function(e){return i(e)})})}},{key:"lastSuccessfulAd",get:function(){return this.storage.getItem("vast-client-last-successful-ad")},set:function(e){this.storage.setItem("vast-client-last-successful-ad",e)}},{key:"totalCalls",get:function(){return this.storage.getItem("vast-client-total-calls")},set:function(e){this.storage.setItem("vast-client-total-calls",e)}},{key:"totalCallsTimeout",get:function(){return this.storage.getItem("vast-client-total-calls-timeout")},set:function(e){this.storage.setItem("vast-client-total-calls-timeout",e)}}]),r}(),Y=function(e){function o(e,t,i){var r,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;for(var a in l(this,o),(r=u(this,c(o).call(this))).ad=t,r.creative=i,r.variation=n,r.muted=!1,r.impressed=!1,r.skippable=!1,r.trackingEvents={},r._alreadyTriggeredQuartiles={},r.emitAlwaysEvents=["creativeView","start","firstQuartile","midpoint","thirdQuartile","complete","resume","pause","rewind","skip","closeLinear","close"],r.creative.trackingEvents){var s=r.creative.trackingEvents[a];r.trackingEvents[a]=s.slice(0)}return r.creative instanceof A?r._initLinearTracking():r._initVariationTracking(),e&&r.on("start",function(){e.lastSuccessfulAd=Date.now()}),r}return a(o,V),n(o,[{key:"_initLinearTracking",value:function(){this.linear=!0,this.skipDelay=this.creative.skipDelay,this.setDuration(this.creative.duration),this.clickThroughURLTemplate=this.creative.videoClickThroughURLTemplate,this.clickTrackingURLTemplates=this.creative.videoClickTrackingURLTemplates}},{key:"_initVariationTracking",value:function(){if(this.linear=!1,this.skipDelay=-1,this.variation){for(var e in this.variation.trackingEvents){var t=this.variation.trackingEvents[e];this.trackingEvents[e]?this.trackingEvents[e]=this.trackingEvents[e].concat(t.slice(0)):this.trackingEvents[e]=t.slice(0)}this.variation instanceof w?(this.clickThroughURLTemplate=this.variation.nonlinearClickThroughURLTemplate,this.clickTrackingURLTemplates=this.variation.nonlinearClickTrackingURLTemplates,this.setDuration(this.variation.minSuggestedDuration)):this.variation instanceof d&&(this.clickThroughURLTemplate=this.variation.companionClickThroughURLTemplate,this.clickTrackingURLTemplates=this.variation.companionClickTrackingURLTemplates)}}},{key:"setDuration",value:function(e){this.assetDuration=e,this.quartiles={firstQuartile:Math.round(25*this.assetDuration)/100,midpoint:Math.round(50*this.assetDuration)/100,thirdQuartile:Math.round(75*this.assetDuration)/100}}},{key:"setProgress",value:function(e){var t=this,i=this.skipDelay||-1;if(-1===i||this.skippable||(e<i?this.emit("skip-countdown",i-e):(this.skippable=!0,this.emit("skip-countdown",0))),0<this.assetDuration){var r=[];if(0<e){var n=Math.round(e/this.assetDuration*100);for(var a in r.push("start"),r.push("progress-".concat(n,"%")),r.push("progress-".concat(Math.round(e))),this.quartiles)this.isQuartileReached(a,this.quartiles[a],e)&&(r.push(a),this._alreadyTriggeredQuartiles[a]=!0)}r.forEach(function(e){t.track(e,!0)}),e<this.progress&&this.track("rewind")}this.progress=e}},{key:"isQuartileReached",value:function(e,t,i){var r=!1;return t<=i&&!this._alreadyTriggeredQuartiles[e]&&(r=!0),r}},{key:"setMuted",value:function(e){this.muted!==e&&this.track(e?"mute":"unmute"),this.muted=e}},{key:"setPaused",value:function(e){this.paused!==e&&this.track(e?"pause":"resume"),this.paused=e}},{key:"setFullscreen",value:function(e){this.fullscreen!==e&&this.track(e?"fullscreen":"exitFullscreen"),this.fullscreen=e}},{key:"setExpand",value:function(e){this.expanded!==e&&(this.track(e?"expand":"collapse"),this.track(e?"playerExpand":"playerCollapse")),this.expanded=e}},{key:"setSkipDelay",value:function(e){"number"==typeof e&&(this.skipDelay=e)}},{key:"trackImpression",value:function(){this.impressed||(this.impressed=!0,this.trackURLs(this.ad.impressionURLTemplates),this.track("creativeView"))}},{key:"errorWithCode",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.trackURLs(this.ad.errorURLTemplates,{ERRORCODE:e},{isCustomCode:t})}},{key:"complete",value:function(){this.track("complete")}},{key:"close",value:function(){this.track(this.linear?"closeLinear":"close")}},{key:"skip",value:function(){this.track("skip")}},{key:"load",value:function(){this.track("loaded")}},{key:"click",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.clickTrackingURLTemplates&&this.clickTrackingURLTemplates.length&&this.trackURLs(this.clickTrackingURLTemplates);var t=this.clickThroughURLTemplate||e;if(t){var i=this.linear?{CONTENTPLAYHEAD:this.progressFormatted()}:{},r=k.resolveURLTemplates([t],i)[0];this.emit("clickthrough",r)}}},{key:"track",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];"closeLinear"===e&&!this.trackingEvents[e]&&this.trackingEvents.close&&(e="close");var i=this.trackingEvents[e],r=-1<this.emitAlwaysEvents.indexOf(e);i?(this.emit(e,{trackingURLTemplates:i}),this.trackURLs(i)):r&&this.emit(e,null),t&&(delete this.trackingEvents[e],r&&this.emitAlwaysEvents.splice(this.emitAlwaysEvents.indexOf(e),1))}},{key:"trackURLs",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};this.linear&&(this.creative&&this.creative.mediaFiles&&this.creative.mediaFiles[0]&&this.creative.mediaFiles[0].fileURL&&(t.ASSETURI=this.creative.mediaFiles[0].fileURL),t.CONTENTPLAYHEAD=this.progressFormatted()),k.track(e,t,i)}},{key:"progressFormatted",value:function(){var e=parseInt(this.progress),t=e/3600;t.length<2&&(t="0".concat(t));var i=e/60%60;i.length<2&&(i="0".concat(i));var r=e%60;r.length<2&&(r="0".concat(i));var n=parseInt(100*(this.progress-e));return"".concat(t,":").concat(i,":").concat(r,".").concat(n)}}]),o}();return e.VASTClient=G,e.VASTParser=j,e.VASTTracker=Y,e}({});
